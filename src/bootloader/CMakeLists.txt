
# HAL and drivers, generated by cubemx
add_subdirectory(board)



list(APPEND BOOTLOADER_SOURCE_FILES
   "main.c"
   "bootloader_main.c"
   "bootloader_uart.c"
   "led.c"
   "app_loader.c"
   "printf.c"
)

list(APPEND BOOTLOADER_INC_DIRS
   "include"
)


set(LINKER_SCRIPT "${CMAKE_CURRENT_LIST_DIR}/bootloader.ld")
get_filename_component(MEM_MAP_DIR ../ ABSOLUTE)

add_executable(${BOOTLOADER_NAME}.elf ${BOOTLOADER_SOURCE_FILES})

target_compile_definitions(${BOOTLOADER_NAME}.elf PRIVATE STM32F407xx USE_HAL_DRIVER)
target_include_directories(${BOOTLOADER_NAME}.elf PUBLIC ${BOOTLOADER_INC_DIRS})
target_link_libraries(${BOOTLOADER_NAME}.elf bootloader_board common "-T ${LINKER_SCRIPT}" "-L ${MEM_MAP_DIR}")


add_custom_command(TARGET ${BOOTLOADER_NAME}.elf
    POST_BUILD
    COMMAND ${CMAKE_OBJCOPY} --verbose --pad-to 0x8040000 --gap-fill 0xFF -O binary ${BOOTLOADER_NAME}.elf ${BOOTLOADER_NAME}.bin
    DEPENDS ${BOOTLOADER_NAME}.elf)